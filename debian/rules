#!/usr/bin/make -f

maintainer ?= 1

ifeq ($(maintainer),1)
export DH_VERBOSE = 1
export DH_OPTIONS = -v
make_flags = V=1
export V=1
endif

include /usr/share/dpkg/architecture.mk

N := netatalk

export DEB_BUILD_MAINT_OPTIONS=hardening=+all
CFLAGS  := $(shell dpkg-buildflags --get CFLAGS)
CPPLAGS := $(shell dpkg-buildflags --get CPPFLAGS)
LDFLAGS := -Wl,--as-needed $(shell dpkg-buildflags --get LDFLAGS)

ifneq ($(maintainer),1)
	CFLAGS := -w $(CFLAGS)
endif

ifeq ($(DEB_BUILD_GNU_TYPE), $(DEB_HOST_GNU_TYPE))
        confflags += --build=$(DEB_HOST_GNU_TYPE)
else
        confflags += --build=$(DEB_HOST_GNU_TYPE) --host=$(DEB_HOST_GNU_TYPE)
        export DEB_BUILD_OPTIONS += nocheck
endif

MIGRATE_DIR = lib$(N)-dev $(N) $(N)-dbg $(N)-uams-standalone $(N)-uams-pam $(N)-uams-extra

%:
	dh $@

override_dh_auto_configure:
	./configure $(confflags) CFLAGS="$(CFLAGS) $(CPPLAGS)" LDFLAGS="$(LDFLAGS)" \
		--prefix=/usr --sysconfdir=/etc --bindir=\$${prefix}/bin --sbindir=\$${prefix}/sbin \
		--libexecdir=\$${prefix}/lib/$(DEB_HOST_MULTIARCH) --libdir=\$${prefix}/lib/$(DEB_HOST_MULTIARCH) \
		--localstatedir=/var/lib --with-lockfile=/run/netatalk.pid --includedir=\$${prefix}/include \
		--datarootdir=\$${prefix}/share --datadir=\$${prefix}/share --infodir=\$${prefix}/share/info \
		--localedir=\$${datarootdir}/locale --mandir=\$${datarootdir}/man --docdir=\$${datarootdir}/doc/netatalk \
		--htmldir=\$${docdir} --dvidir=\$${docdir} --pdfdir=\$${docdir}	--psdir=\$${docdir} \
		--with-uams-path=\$${libdir}/netatalk --with-pam-confdir=\$${sysconfdir}/pam.d \
		--with-dbus-sysconf-dir=\$${sysconfdir}/dbus-1/system.d --with-bdb="/usr/include /usr/include/$(DEB_HOST_MULTIARCH)" \
		--enable-dependency-tracking --enable-largefile --enable-zeroconf --with-sysroot=/ --with-afpstats \
		--with-kerberos --with-gssapi --with-acls --with-libevent=no --without-tdb --with-init-style=debian-systemd \
		--with-cnid-dbd-backend --with-cnid-last-backend --with-cnid-tdb-backend --with-cnid-default-backend=dbd \
		--enable-tcp-wrappers --enable-quota --enable-admin-group --with-cracklib --with-pam --with-ldap \
		--with-docbook=/usr/share/xml/docbook/stylesheet/docbook-xsl --enable-pgp-uam --enable-krbV-uam \
		--with-tracker-pkgconfig-version=1.0 --enable-sendfile --with-shadow

override_dh_autoreconf:
	dh_autoreconf --as-needed autoreconf -- -ivf --no-recursive

override_dh_auto_build-arch:
	dh_auto_build
	# generate maintainer preinst script to migrate doc dirs to symlinks
	# (for all packages except libnetatalk and netatalk-doc)
	for p in $(MIGRATE_DIR); do \
		sed -e "s/@PKG@/$$p/g" debian/migrate-doc-dir.preinst.in >debian/$$p.preinst; \
	done

override_dh_auto_build-indep:
	$(MAKE) html -C doc/manual

override_dh_auto_install-indep:
	$(MAKE) install -C doc/manual

override_dh_install-arch:
	mkdir -p debian/libnetatalk-dev/usr/bin
	mv debian/tmp/usr/bin/netatalk-config \
		debian/libnetatalk-dev/usr/bin/$(DEB_HOST_GNU_TYPE)-netatalk-config
	dh_installdocs -A -N$(N)-doc --link-doc=lib$(N)
	dh_install --list-missing

override_dh_strip-arch:
	dh_strip -a --dbg-package=$(N)-dbg

override_dh_auto_clean:
	[ ! -f Makefile ] || $(MAKE) distclean || true

override_dh_auto_test-indep:
	#pass

override_dh_clean:
	dh_clean
	for p in $(MIGRATE_DIR); do \
		rm -f debian/$$p.preinst; \
	done
